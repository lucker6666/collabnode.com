angular.module("collabApp",["collabApp.services","ui","ui.bootstrap"]).config(["$routeProvider","$locationProvider",function(a,c){a.when("/",{templateUrl:"/partials/boardlist",controller:boardCtrl}).when("/board/:boardId",{templateUrl:"/partials/cardlist",controller:memberCtrl}).when("/user/login",{templateUrl:"/partials/login",controller:appCtrl}).when("/user/:id",{templateUrl:"/partials/boardlist",controller:userCtrl}).when("/notification",{templateUrl:"/partials/notification",controller:notificationCtrl}).when("/user/register",
{templateUrl:"/partials/register",controller:appCtrl}).otherwise({redirectTo:"/"});c.html5Mode(!0)}]).service("shareService",function(){var a,c,b;return{setCurrentCard:function(b){a=b},getCurrentCard:function(){return a},setCurrentUser:function(a){c=a},getCurrentUser:function(){return c},setCurrentBoard:function(a){b=a},getCurrentBoard:function(){return b}}});
function appCtrl(a,c,b,e,d){a.logout=function(){c.get("/user/logout").then(function(){b.path("/user/login")})};e.emit("session:getCurrentUser",{},function(b,c){a.session={};a.session.user=c;d.setCurrentUser(c)});e.emit("message:getUnreads",{},function(b,d){a.messages=d});e.on("message:notification",function(b){a.messages.push(b)});e.on("message:reset",function(b){a.messages=[]})}
function notificationCtrl(a,c,b,e,d,f){c=_.pluck(a.messages,"_id");b=_.pluck(a.messages,"board");e.emit("message:markRead",{msgids:c,boards:b});e.emit("message:list",{},function(b,d){var c="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ");d=_.map(d,function(a){var b=new Date(a.created_time),d=b.getMonth(),f=b.getDate(),e=b.getHours(),b=b.getMinutes();a.created_time_str=c[d]+" "+f+" "+e+":"+b;return a});a.msgs=d})}
function memberCtrl(a,c,b,e,d){c.emit("board:subscribe",{_id:b.boardId});c.emit("board:retrieve",{_id:b.boardId},function(a,b){d.setCurrentBoard(b)});c.emit("board:getMembers",{_id:b.boardId},function(b,d){a.members=d});c.on("board:addMember",function(b){a.members.push(b)});c.on("board:removeMember",function(b){a.members=_.reject(a.members,function(a){return a._id==b})});c.on("board:quit",function(b){a.members=_.reject(a.members,function(a){return a._id==b})});a.search=function(d){return e({method:"GET",
url:"/api/search/users",params:{q:d,boardId:b.boardId}}).then(function(b,d,c,l){return a.results=b.data.users})};a.search_with_socket_A=function(){c.emit("user:search",{q:a.username},function(b,d){a.results=d})};a.search_with_socket_B=function(a){return c.emit("user:search",{q:a},function(a,b){return b})};a.addMember=function(){var d=_.find(a.results,function(b){return b.email==a.email});a.email="";c.emit("board:addMember",{member:d,_id:b.boardId})};a.removeMember=function(){c.emit("board:removeMember",
{member:a.members[this.$index],boardId:b.boardId})}}
function cardItemDialogCtrl(a,c,b,e,d,f,g){a.dbChooser=$("#db-chooser");a.isAttachCollapsed=!0;a.isCollapsed=!0;a.isDescCollapsed=!0;a.isDisabled=!0;a.card=e.getCurrentCard();a.user=e.getCurrentUser();a.board=e.getCurrentBoard();g.emit("card:retrieve",{cardId:a.card._id},function(b,d){a.card=d});g.on("card:addAttachment",function(b){a.card.attachments.push(b)});a.deleteCard=function(){a.user._id!=a.card.owner._id&&a.user._id!=a.card.createdby?alert("permission denied"):(d.close(),g.emit("card:delete",
{cardId:a.card._id,boardId:f.boardId}));a.cardname=""};a.addDesc=function(){g.emit("card:addDesc",{cardId:a.card._id,description:a.description,boardId:f.boardId});a.card.description=a.description;a.description="";a.isDescCollapsed=!0};a.chooseFromDropbox=function(){dropbox_options={linkType:"preview",multiselect:!1,success:function(b){var d={};d.name=b[0].name;d.link=b[0].link;g.emit("card:addAttachment",{cardId:a.card._id,boardId:f.boardId,attachment:d})},cancel:function(){}};Dropbox.choose(dropbox_options)}}
function cardItemCtrl(a,c,b,e,d){a.openCardEditDialog=function(b){e.setCurrentCard(a.card);a.opts={backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:"/partials/carddetail",controller:"cardItemDialogCtrl",dialogClass:"modal card-detail-modal"};d.dialog(a.opts).open().then(function(a){a&&alert("dialog closed with result: "+a)})}}
function cardCtrl(a,c,b,e){a.member&&c.emit("card:list",{boardId:b.boardId,userId:a.member._id},function(b,c){a.cards=c});c.on("card:create",function(b){b.owner==a.member._id&&a.cards.push(b)});c.on("card:delete",function(b){a.cards=_.reject(a.cards,function(a){return a._id==b})});c.on("card:addDesc",function(b){a.cards=_.map(a.cards,function(a){a._id==b._id&&(a.description=b.description);return a})});a.createCard=function(d){console.log(a.members[this.$index]);c.emit("card:create",{title:a.card_title,
boardId:b.boardId,owner:a.members[this.$index]});a.card_title=""};a.filterByOwner=function(b){return b.owner==a.member._id}}
function boardCtrl(a,c){c.emit("user:retrieve",{},function(b,c){a.user=c});c.emit("board:getOwnBoards",{},function(b,c){a.boards=c});c.emit("board:getJoinBoards",{},function(b,c){c.length?(a.joinboards=c,a.joinboard_flag=!0):a.joinboard_flag=!1});c.on("board:create",function(b){$("#createBoardModal").modal("hide");a.boards.push(b)});c.on("board:delete",function(b){0==b.code?(a.boards=_.reject(a.boards,function(a){return a._id==b._id}),console.log(a.boards)):alert("please remove the board members first")});
a.createBoard=function(){c.emit("board:create",{name:a.board_name},function(a,c){});a.board_name=""};a.deleteBoard=function(a){c.emit("board:delete",{_id:a})};a.quitBoard=function(){var b=a.joinboards[this.$index];c.emit("board:quit",{_id:b._id,owner:b.owner,name:b.name},function(c,d){1==d&&(a.joinboards=_.reject(a.joinboards,function(a){return a._id==b._id}),0==a.joinboards.length&&(a.joinboard_flag=!1))})}}
function commentCtrl(a,c,b,e){a.isCollapsedNewReply=!0;a.isDisabled=!0;c.on("comment:create",function(b){var c=new Date(b.created_time),e=c.getMonth(),k=c.getDate(),h=c.getHours(),c=c.getMinutes();b.created_time_str="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")[e]+" "+k+" "+h+":"+c;a.comments.push(b)});c.emit("comment:list",{cardId:a.card._id},function(b,c){var e="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ");c=_.map(c,function(a){var b=new Date(a.created_time),c=b.getMonth(),
d=b.getDate(),f=b.getHours(),b=b.getMinutes();a.created_time_str=e[c]+" "+d+" "+f+":"+b;return a});a.comments=c});a.createComment=function(){if(a.user._id!=a.card.owner._id){var d={};d._id=a.card.owner._id;d.nickname=a.card.owner.nickname;d.email=a.card.owner.email;d.md5=a.card.owner.md5;_.some(a.tokens,function(a){return a._id==d._id})||a.tokens.push(d)}c.emit("comment:create",{cardId:a.card._id,content:a.newcomment,boardId:b.boardId,boardName:a.board.name,at:a.tokens});a.tokens=[];a.newcomment=
""};a.search=function(c){if(""==a.newcomment)a.isDisabled=!0;else{a.isDisabled=!1;var f=a.newcomment.indexOf("@");console.log(f);var g=a.newcomment.length-1;console.log(g);console.log(c.keyCode);g>=f&&0<=f&&32!=c.keyCode&&8!=c.keyCode&&50!=c.keyCode&&16!=c.keyCode&&17!=c.keyCode&&18!=c.keyCode?c=!0:(c=!1,a.showresult=!1);c&&(f=a.newcomment.substr(f+1,g),e({method:"GET",url:"/api/search/members",params:{q:f,boardId:b.boardId}}).success(function(b,c,d,e){b=_.reject(b.members,function(b){return _.some(a.tokens,
function(a){return a._id==b._id})});a.showresult=0!=b.length?!0:!1;a.results=b}))}};a.tokens=[];a.addToken=function(b){a.tokens.push(b);b=a.newcomment.indexOf("@");0<=b&&(a.newcomment=a.newcomment.substr(0,b));""==a.newcomment&&(a.isDisabled=!0);a.showresult=!1};a.removeToken=function(){a.tokens.splice(this.$index,1)}}
function userCtrl(a,c,b){b.emit("user:retrieve",{_id:c.id},function(b,c){a.user=c});b.emit("user:getOwnerBoards",{_id:c.id},function(b,c){a.boards=c});b.emit("user:getJoinBoards",{_id:c.id},function(b,c){c.length?(a.joinboards=c,a.joinboard_flag=!0):a.joinboard_flag=!1})}angular.module("collabApp.directives",[]).directive("autoComplete",["$timeout",function(a){return function(c,b,e){b.autocomplete({source:c[e.uiItems],select:function(){a(function(){b.trigger("input")},0)}})}}]);"use strict";
var dropboxChooserModule=angular.module("dropboxChooserModule",[]);dropboxChooserModule.constant("DROPBOX_CONFIG",{BASE_URL:"https://www.dropbox.com",API_KEY:"bu9otnx7trxsblk"});
dropboxChooserModule.factory("dropboxChooserService",["DROPBOX_CONFIG",function(a){var c={appKey:a.API_KEY,addListener:function(a,c,d){a.addEventListener?a.addEventListener(c,d,!1):a.attachEvent("on"+c,d)},removeListener:function(a,c,d){a.removeEventListener?a.removeEventListener(c,d,!1):a.detachEvent("on"+c,d)},_chooserUrl:function(b){var c="direct"==b.linkType?"direct":"preview";b=b._trigger||"js";return a.BASE_URL+"/chooser?origin="+encodeURIComponent(window.location.protocol+"//"+window.location.host)+
"&app_key="+encodeURIComponent(this.appKey)+"&link_type="+c+"&trigger="+b},_createWidgetElement:function(a){var e=document.createElement("iframe");e.src=c._chooserUrl(a);e.style.display="block";e.style.width="660px";e.style.height="440px";e.style.backgroundColor="white";e.style.border="none";return e},_handleMessageEvent:function(a,c,d,f){a=JSON.parse(a.data);"files_selected"==a.method?(c&&c(),d&&d([a.params])):"close_dialog"==a.method&&(c&&c(),f&&f())},createWidget:function(a){var e=c._createWidgetElement(a);
e._handler=function(d){d.source==e.contentWindow&&c._handleMessageEvent(d,null,a.success,a.cancel)};c.addListener(window,"message",e._handler);return e},cleanupWidget:function(a){if(!a._handler)throw"Invalid widget!";c.removeListener(window,"message",a._handler);delete a._handler},choose:function(a){if("undefined"==typeof a)throw"You must pass in options";if(a.iframe){var e=c._createWidgetElement(a),d=document.createElement("div");d.style.position="fixed";d.style.left=d.style.right=d.style.top=d.style.bottom=
"0px";d.style.zIndex="1000";var f=document.createElement("div");f.style.position="absolute";f.style.left=f.style.right=f.style.top=f.style.bottom="0px";f.style.backgroundColor="rgb(160, 160, 160)";f.style.opacity="0.2";f.style.filter="progid:DXImageTransform.Microsoft.Alpha(Opacity=20)";var g=document.createElement("div");g.style.position="relative";g.style.width="660px";g.style.margin="125px auto 0px auto";g.style.border="1px solid #ACACAC";g.style.boxShadow="rgba(0, 0, 0, .2) 0px 4px 16px";g.appendChild(e);
d.appendChild(f);d.appendChild(g);document.body.appendChild(d);var k=function(l){l.source==e.contentWindow&&c._handleMessageEvent(l,function(){document.body.removeChild(d);c.removeListener(window,"message",k)},a.success,a.cancel)}}else{var f=(window.screenX||window.screenLeft)+((window.outerWidth||document.documentElement.offsetWidth)-660)/2,g=(window.screenY||window.screenTop)+((window.outerHeight||document.documentElement.offsetHeight)-440)/2,h=window.open(c._chooserUrl(a),"dropbox","width=660,height=440,left="+
f+",top="+g+",resizable=yes,location=yes");h.focus();k=function(d){d.source!=h&&d.source!=c._ieframe.contentWindow||c._handleMessageEvent(d,function(){h.close();c.removeListener(window,"message",k)},a.success,a.cancel)}}c.addListener(window,"message",k)}};return c}]);
dropboxChooserModule.run(["dropboxChooserService","DROPBOX_CONFIG",function(a,c){var b=document.createElement("style");b.type="text/css";var e=".dropbox-chooser { width: 152px; height: 25px; cursor: pointer; background: url('"+c.BASE_URL+"/static/images/widgets/chooser-button-sprites.png') 0 0}.dropbox-chooser:hover { background-position: 0 -25px}.dropbox-chooser:active { background-position: 0 -50px}.dropbox-chooser-used { background-position: 152px 0 }.dropbox-chooser-used:hover { background-position: 152px -25px}.dropbox-chooser-used:active { background-position: 152px -50px}";
b.styleSheet?b.styleSheet.cssText=e:b.textContent=e;document.getElementsByTagName("head")[0].appendChild(b);(function(){var b=document.createElement("iframe");b.setAttribute("id","dropbox_xcomm");b.setAttribute("src",c.BASE_URL+"/fp/xcomm");b.style.display="none";document.getElementsByTagName("body")[0].appendChild(b);a._ieframe=b})}]);
dropboxChooserModule.directive("dropboxChooser",["dropboxChooserService",function(a){return{priority:1,restrict:"E",transclude:!0,scope:{localModel:"="},template:'<div class="dropbox-chooser"><input type="dropbox-chooser" name="selected-file" style="visibility: hidden;" ng-show="false" /></div>',controller:"DropboxChooserCtrl",link:function(c,b,e){c.inputEl=b.find("input")[0];c.btnEl=b[0];b.bind("click",function(){a.choose({success:function(a){c.files=a;c.inputEl.value=c.files[0].url;c.$emit("DbxChooserSuccess");
c.btnEl.className="dropbox-chooser dropbox-chooser-used"},cancel:function(){c.$emit("DbxChooserCancel")},linkType:c.inputEl.getAttribute("data-link-type")?c.inputEl.getAttribute("data-link-type"):"preview",_trigger:"button"})})},replace:!0}}]);dropboxChooserModule.controller("DropboxChooserCtrl",["$scope",function(a){a.$on("DbxChooserSuccess",function(c){c.targetScope.localModel.fileUrl=c.targetScope.files[0].url;a.$digest()});a.$on("DbxChooserCancel",function(a){console.log("fail")})}]);"use strict";
angular.module("collabApp.services",["ngResource"]).value("version","0.1").factory("socket",["$rootScope",function(a){var c=io.connect();return{on:function(b,e){c.on(b,function(){var b=arguments;a.$apply(function(){e.apply(c,b)})})},emit:function(b,e,d){c.emit(b,e,function(){var b=arguments;a.$apply(function(){d&&d.apply(c,b)})})}}}]);
$(function(a,c,b,e){var d,f,g,k,h;h=e.connect();d=b.Model.extend({idAttribute:"_id",noIoBind:!1,socket:h,url:function(){return"/todo"+(this.id?"/"+this.id:"")},defaults:function(){return{title:"empty todo...",order:f.nextOrder(),done:!1}},initialize:function(){this.get("title")||this.set({title:this.defaults.title});this.on("serverChange",this.serverChange,this);this.on("serverDelete",this.serverDelete,this);this.on("modelCleanup",this.modelCleanup,this);this.noIoBind||(this.ioBind("update",this.serverChange,
this),this.ioBind("delete",this.serverDelete,this),this.ioBind("lock",this.serverLock,this),this.ioBind("unlock",this.serverUnlock,this))},toggle:function(){this.save({done:!this.get("done")})},clear:function(a){this.destroy(a);this.modelCleanup()},serverChange:function(a){a.fromServer=!0;this.set(a)},serverDelete:function(a){"object"===typeof this.collection?this.collection.remove(this):this.trigger("remove",this)},serverLock:function(a){a&&(this.locked=!0)},serverUnlock:function(a){a&&(this.locked=
!1)},modelCleanup:function(){this.ioUnbindAll();return this},locked:!1,lock:function(a){if(!this._locked){a=a?c.clone(a):{};var d=this,e=a.success;a.success=function(b,c,f){d.locked=!0;e?e(d,b):d.trigger("lock",d,b,a)};a.error=b.wrapError(a.error,d,a);return(this.sync||b.sync).call(this,"lock",this,a)}},unlock:function(a){if(this.locked){a=a?c.clone(a):{};var d=this,e=a.success;a.success=function(b,c,f){d._locked=!1;e?e(d,b):d.trigger("unlock",d,b,a)};a.error=b.wrapError(a.error,d,a);return(this.sync||
b.sync).call(this,"unlock",this,a)}}});f=new (b.Collection.extend({model:d,socket:h,url:function(){return"/todo"+(this.id?"/"+this.id:"")},initialize:function(){this.on("collectionCleanup",this.collectionCleanup,this);h.on("/todo:create",this.serverCreate,this)},serverCreate:function(a){if(a){var b=f.get(a._id);"undefined"===typeof b?f.add(a):(a.fromServer=!0,b.set(a))}},collectionCleanup:function(a){this.ioUnbindAll();this.each(function(a){a.modelCleanup()});return this},done:function(){return this.filter(function(a){return a.get("done")})},
remaining:function(){return this.without.apply(this,this.done())},filterbyOwner:function(a,b){return c.intersection(this.where({owner:a}),b)},nextOrder:function(){return this.length?this.last().get("order")+1:1},comparator:function(a){return a.get("order")}}));g=b.View.extend({tagName:"li",template:c.template(a("#item-template").html()),events:{"click .toggle":"toggleDone","dblclick .view":"edit","click a.destroy":"clear","keypress .edit":"updateOnEnter","blur .edit":"close"},initialize:function(){this.model.on("change",
this.render,this);this.model.on("lock",this.serverLock,this);this.model.on("unlock",this.serverUnlock,this);f.on("remove",this.serverDelete,this)},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.toggleClass("done",this.model.get("done"));this.input=this.$(".edit");return this},toggleDone:function(){this.model.toggle()},edit:function(){this.model.locked||(this.$el.addClass("editing"),this.input.focus(),this.model.lock())},close:function(){var a=this.input.val();a||this.clear();
this.model.save({title:a});this.$el.removeClass("editing");this.model.unlock()},updateOnEnter:function(a){13===a.keyCode&&this.close()},clear:function(){this.model.locked||this.model.clear()},serverDelete:function(a){a.id===this.model.id&&(this.model.clear({silent:!0}),this.$el.remove())},serverLock:function(){!this.$el.hasClass("editing")&&this.model.locked&&(this.$el.addClass("locked"),this.$(".toggle").attr("disabled",!0))},serverUnlock:function(){this.$el.removeClass("locked");this.$(".toggle").attr("disabled",
!1)}});k=b.View.extend({uids:[],inputs:[],el:a("#card-container"),statsTemplate:c.template(a("#stats-template").html()),events:{"click #clear-completed":"clearCompleted","click #toggle-all":"toggleAllComplete"},initialize:function(a){var b,d,e;for(b in a.users)e=a.users[b]._id,d="new-todo-"+e,this.uids[d]=e,d="keypress #"+d,this.events[d]="createOnEnter";this.delegateEvents();f.on("add",this.addOne,this);f.on("reset",this.addAll,this);f.on("all",this.render,this);f.fetch({success:function(b,d){var e=
a.todo,f;c.each(e&&e.locks?e.locks:[],function(a){(f=b.get(a))&&f.lock()})}})},render:function(){var b=[],c;for(c in this.uids){var d=this.uids[c],e=f.filterbyOwner(d,f.done()).length,g=f.filterbyOwner(d,f.remaining()).length;b[d]=this.statsTemplate({done:e,remaining:g});this.$("#main-"+d).hide();this.$("#footer-"+d).hide()}f.length&&f.each(function(c){c=c.get("owner");a("#main-"+c).show();a("#footer-"+c).show();a("#footer-"+c).html(b[c])})},addOne:function(b){var c=new g({model:b});a("#todo-list-"+
b.get("owner")).append(c.render().el)},addAll:function(){f.each(this.addOne)},createOnEnter:function(b){if(13===b.keyCode&&(b=b.target.id,a("#"+b).val())){var c=a("#"+b).val(),e=c.match(/\d{1,2}:\d{2}([ap]m)/),e=null==e?"":e[0]+" ",c=c.match(/[Mm]onday|[Tt]uesday|[Ww]ensday|[Tt]hursday|[Ff]riday|[Ss]aturday|[Ss]unday/),c=null==c?"":c;(new d({title:a("#"+b).val(),owner:this.uids[b],deadline:e+c})).save();a("#"+b).val("")}},clearCompleted:function(){c.each(f.done(),function(a){a.clear()});return!1},
toggleAllComplete:function(){var a=this.allCheckbox.checked;f.each(function(b){b.save({done:a})})}});h.emit("connect",["todo"],function(a,b){a?console.log("Unable to connect."):new k(b)})}(jQuery,_,Backbone,io));
